# 1. 今日工作总结

1. 汇总扣款和扣费用差额接口
2. 排查数据库慢sql的问题

# 2. sql的问题

今天遇到数据慢sql，原因是没走索引，但是数据库的索引是建了的。
因为数据索引的区分度突然变成了1。   Cardinality

```sql
show index from table
```

通过查询stack overflow 得知 innodb在数据量修改超过10%或者全局自增大于多少的时候会更新统计信息。

> To immediately update statistics, run [`ANALYZE TABLE`](https://dev.mysql.com/doc/refman/5.7/en/analyze-table.html) (if [`innodb_stats_auto_recalc`](https://dev.mysql.com/doc/refman/5.7/en/innodb-parameters.html#sysvar_innodb_stats_auto_recalc) is enabled, statistics are updated automatically within a few seconds assuming that the 10% threshold for changed table rows is reached):

统计信息的区分度变成1，因为innodb随机采样的时候，有一个一样的数据，所以是1。 这块有点没看懂

然后又怀疑是不是唯一索引没用，可能随机采样的时候有两条一样的数据导致为1

也有可能是读取索引文件失败了，所以为1

后来过了半个小时左右 自动恢复了。

```sql
mysql> SELECT * FROM mysql.innodb_table_stats WHERE table_name like 't1'\G
*************************** 1. row ***************************
           database_name: test
              table_name: t1
             last_update: 2014-03-14 14:36:34
                  n_rows: 5
    clustered_index_size: 1
sum_of_other_index_sizes: 2
```

- The `stat_name` column shows the following types of statistics:
  - `size`: Where `stat_name`=`size`, the `stat_value` column displays the total number of pages in the index.
  - `n_leaf_pages`: Where `stat_name`=`n_leaf_pages`, the `stat_value` column displays the number of leaf pages in the index.
  - `n_diff_pfx*`NN`*`: Where `stat_name`=`n_diff_pfx01`, the `stat_value` column displays the number of distinct values in the first column of the index. Where `stat_name`=`n_diff_pfx02`, the `stat_value` column displays the number of distinct values in the first two columns of the index, and so on. Where `stat_name`=`n_diff_pfx*`NN`*`, the `stat_description` column shows a comma separated list of the index columns that are counted.

```sql
mysql> SELECT index_name, stat_name, stat_value, stat_description
       FROM mysql.innodb_index_stats WHERE table_name like 't1';
+------------+--------------+------------+-----------------------------------+
| index_name | stat_name    | stat_value | stat_description                  |
+------------+--------------+------------+-----------------------------------+
| PRIMARY    | n_diff_pfx01 |          1 | a                                 |
| PRIMARY    | n_diff_pfx02 |          5 | a,b                               |
| PRIMARY    | n_leaf_pages |          1 | Number of leaf pages in the index |
| PRIMARY    | size         |          1 | Number of pages in the index      |
| i1         | n_diff_pfx01 |          1 | c                                 |
| i1         | n_diff_pfx02 |          2 | c,d                               |
| i1         | n_diff_pfx03 |          2 | c,d,a                             |
| i1         | n_diff_pfx04 |          5 | c,d,a,b                           |
| i1         | n_leaf_pages |          1 | Number of leaf pages in the index |
| i1         | size         |          1 | Number of pages in the index      |
| i2uniq     | n_diff_pfx01 |          2 | e                                 |
| i2uniq     | n_diff_pfx02 |          5 | e,f                               |
| i2uniq     | n_leaf_pages |          1 | Number of leaf pages in the index |
| i2uniq     | size         |          1 | Number of pages in the index      |
+------------+--------------+------------+-----------------------------------+
```

![image-20230203094540377](C:\Users\86199\Desktop\notebook\工作笔记\imgs\image-20230203094540377.png)